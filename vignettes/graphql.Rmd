---
title: "Custom Meetup Queries"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Custom Meetup Queries}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
#| include: false
#| label: setup

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = TRUE
)
vcr::vcr_configure_log()
vcr::setup_knitr(prefix = "graphql-")
meetupr:::mock_if_no_auth()
Sys.setenv(MEETUPR_DEBUG = "")
```

```{r}
#| label: load

library(meetupr)
library(dplyr)
library(httr2)
```


## When to Use Custom Queries

Use custom GraphQL queries when:
- Wrapper functions don't provide needed fields
- You need complex filtering or field selection
- Working with new API features not yet wrapped

## Using extra_graphql in Wrapper Functions

The `get_events()` function accepts an `extra_graphql` parameter to add custom fields:

```{r}
#| label: event-highres
#| cassette: true

extra_fields <- "
    featuredEventPhoto {
      highResUrl
      id
    }
  "

events <- get_events(
  "rladies-lagos",
  extra_graphql = extra_fields
)

events
```

## Custom Queries from Scratch

For complete control, build queries using `meetup_template_query()` directly:

```{r}
#| label: group-query
custom_query <- "
  query GetGroupWithDetails($urlname: String!) {
    groupByUrlname(urlname: $urlname) {
      id
      name
      description
      city
      country
      timezone
      
      memberships {
        totalCount
      }
    }
  }"

```

In this example, we fetch detailed group info including member count.
It also demonstrates using a variable `$urlname` for flexibility.
In this case, we can pass the variable when calling `meetup_query()`, which allows reusing the query for different groups.

```{r}
#| label: group-details
#| cassette: true

lagos <- meetup_query(
  custom_query,
  urlname = "rladies-lagos"
)
lagos

ottawa <- meetup_query(
  custom_query,
  urlname = "rladies-ottawa"
)
ottawa

```

The `meetup_query()` function handles variable substitution by passing them as additional arguments (captured by `...`).

To learn how to explore the schema and build queries, see the [API Introspection vignette](introspection.html).

## Debug Mode

Enable debug mode to see request/response details:

```{r}
#| label: debug-mode
#| cassette: true

# Enable debug mode
Sys.setenv(MEETUPR_DEBUG = "1")

debug_query <- "
  query DebugExample($urlname: String!) {
    groupByUrlname(urlname: $urlname) {
      id
      name
      memberships { totalCount }
    }
  }"

# This will show detailed request/response information
result <- meetup_query(
  debug_query,
  urlname = "rladies-san-francisco"
)

# Disable debug mode
Sys.setenv(MEETUPR_DEBUG = "0")

str(result$data$groupByUrlname)

```


## Best Practices

### Field Selection
Only request fields you need to minimize response size:

```{r }
#| label: field-selection

# Don't fetch everything
heavy_query <- '
query {
  groupByUrlname(urlname: "rladies-sf") {
    pastEvents(input: {first: 100}) {
      edges {
        node {
          # All fields including large nested objects
        }
      }
    }
  }
}'

# Be selective
optimized_query <- '
query {
  groupByUrlname(urlname: "rladies-sf") {
    pastEvents(input: {first: 100}) {
      edges {
        node {
          id
          title
          dateTime
          going
          # Only what you need
        }
      }
    }
  }
}'
```


## Resources

- **GraphQL documentation**: https://www.meetup.com/api/general/
