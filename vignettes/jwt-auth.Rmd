---
title: "Setting up JWT Authentication for M2M Workflows"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{JWT Authentication Setup}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

## Overview

The JWT (JSON Web Token) authentication flow enables machine-to-machine (M2M) communication with the Meetup API without requiring user interaction. 
This is perfect for:

- GitHub Actions / CI/CD pipelines  
- Server-side applications  
- Automated data collection scripts  

## Required Environment Variables

To use JWT authentication, you need to set three environment variables:

- `MEETUP_CLIENT_ID` - Your OAuth Client ID  
- `MEETUP_MEMBER_ID` - Your Meetup member ID (must own the OAuth client)  
- `MEETUP_RSA_PATH` - RSA private key in PEM format  

## Step-by-Step Setup

### Step 1: Create an OAuth Application

1. Go to https://secure.meetup.com/meetup_api/oauth_consumers/
2. Click "Create New Consumer" or "Register OAuth Consumer"
3. Fill in the required fields:
   - **Consumer Name**: A descriptive name for your application
   - **Application URL**: Your application's homepage (can be GitHub repo)
   - **Redirect URL**: For JWT flow, this won't be used but is required
   - **Description**: Brief description of your use case

4. Click "Submit" to create your OAuth consumer
5. **Save the Client ID** - this becomes your `MEETUP_CLIENT_ID`

### Step 2: Find Your Member ID

You need the numeric member ID of the Meetup account that owns the OAuth client.

**Method 1: From your profile URL**

1. Go to your Meetup profile  
2. Look at the URL: `https://www.meetup.com/members/123456789/`  
3. The number (`123456789`) is your member ID  

**Method 2: Using the GraphQL API** (if you have existing auth)

```r
library(meetupr)
query <- 'query { self { id } }'
result <- meetup_query(query)
member_id <- result$data$self$id
```

### Step 3: Generate RSA Signing Keys

1. Go back to your OAuth consumer page: https://secure.meetup.com/meetup_api/oauth_consumers/  
2. Click "Edit" next to your consumer  
3. Scroll down to find "JWT Signing Keys" or "RSA Keys" section  
4. Click "Generate New Key" or "Add Signing Key"
5. Meetup will generate an RSA key pair and display:  
   - **Key ID**: A short identifier (e.g., `abc123def456`)  
   - **Private Key**: PEM-formatted private key starting with `-----BEGIN PRIVATE KEY-----`  

6. **Copy both values immediately** - you won't be able to see the private key again  
7. The Key ID can be included as a comment in the private key for convenience  

### Step 4: Set Environment Variables

#### For Local Development

Add to your `.Renviron` file (use `usethis::edit_r_environ()`):

```bash
MEETUP_CLIENT_ID=your_client_id_here
MEETUP_MEMBER_ID=123456789
```

#### For the private key, you can either:

1. Store it in a file and set `MEETUP_RSA_PATH` to the file path, e.g.:

```bash
MEETUP_RSA_PATH="/path/to/your_private_key"
```

And save the private key in that file.

2. Or, store the entire private key directly in the environment variable, but will require proper escaping of newlines (`\n`), e.g.:

```bash
MEETUP_RSA_KEY="-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASC...\n-----END PRIVATE KEY-----"
```


#### For GitHub Actions

1. Go to your GitHub repository  
2. Navigate to Settings → Secrets and variables → Actions  
3. Add three repository secrets:  
   - **Name**: `MEETUP_CLIENT_ID`, **Value**: Your OAuth Client ID  
   - **Name**: `MEETUP_MEMBER_ID`, **Value**: Your member ID  
   - **Name**: `MEETUP_RSA_KEY`, **Value**: Your full private key (including `-----BEGIN PRIVATE KEY-----` and `-----END PRIVATE KEY-----`)  


### Step 5: Test Your Setup

```r
library(meetupr)

meetup_sitrep()
```

## Example GitHub Action

Create `.github/workflows/meetup-sync.yml`:

```yaml
name: Sync Meetup Data

on:
  schedule:
    - cron: '0 8 * * 1'  # Every Monday at 8 AM UTC
  workflow_dispatch:     # Allow manual runs

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: r-lib/actions/setup-r@v2
      with:
        use-public-rspm: true
        
    - name: Install dependencies
      run: |
        install.packages(c("remotes", "dplyr"))
        remotes::install_github("rladies/meetupr")
      shell: Rscript {0}
      
    - name: Fetch events
      env:
        MEETUP_CLIENT_ID: ${{ secrets.MEETUP_CLIENT_ID }}
        MEETUP_MEMBER_ID: ${{ secrets.MEETUP_MEMBER_ID }}
        MEETUP_RSA_KEY: ${{ secrets.MEETUP_RSA_KEY }}
      run: |
        library(meetupr)
        library(dplyr)
        
        # Get events for your group
        events <- get_events("your-group-urlname")
        cat("Found", nrow(events), "events\n")
        
        # Save or process your data
        write.csv(events, "events.csv", row.names = FALSE)
      shell: Rscript {0}
```

## Security Best Practices

### Protecting Your Private Key

1. Never commit private keys to version control  
2. Use environment variables or secret management  
3. Rotate keys periodically  
4. Use different keys for different environments  

### Key Rotation

To rotate your signing key:

1. Generate a new key in your OAuth consumer settings  
2. Update your environment variables with the new key  
3. Delete the old key from Meetup (optional, but recommended)  

### Access Control

- The member ID must be the owner of the OAuth client  
- JWT tokens are short-lived (2 minutes) for security  
- Each request generates a fresh token automatically  

## Troubleshooting

### Common Issues

**"Invalid JWT signature"**  
- Check that your private key is complete and properly formatted  
- Ensure no extra spaces or line breaks in the key  
- Verify the Key ID matches what's in Meetup  

**"Unauthorized member"**  
- Confirm the member ID is the owner of the OAuth client  
- Check that the OAuth client is active and approved  

**"Invalid client"**  
- Verify your client ID is correct  
- Ensure the OAuth consumer exists and is active  

## Additional Resources

- [Meetup API Authentication Documentation](https://www.meetup.com/api/authentication/)  
- [JSON Web Token (JWT) Introduction](https://jwt.io/introduction/)  
- [GitHub Actions Documentation](https://docs.github.com/en/actions)  
- [R Environment Variables Guide](https://cran.r-project.org/web/packages/startup/vignettes/startup-intro.html)  
